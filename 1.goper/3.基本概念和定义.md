# 基本概念和定义

在进一步了解 Goper 之前，先了解一些基本概念，这些概念将在后面的文档多次出现，因此有必要先知道。

如果在这一节读完之后你还是对这些概念不清楚，也不必烦恼，后面阅读过程中如果提及这些概念，回过头再来看看。

---
## 基本概念

### 配置文件
Goper 运行时需要一个配置文件，这个文件配置了各个组件需要的参数，指引着 Goper 系统的运行，可以说 Goper 的组件逻辑是由配置驱动的。

Goper 使用可执行文件同级目录下的 goper.gs 文件作为默认配置文件。

goper.gs 配置文件是基于作者的另一个开源项目：[gson]()。这是作者为自己设计的一种轻量级的数据交换格式，用于配置文件的读取。如果你不清楚这种文件的规则，可以阅读[这篇文章]()了解。

如前所述，Goper 是一个可拔插的框架，因此，如果你不喜欢 gson 的这种数据交换格式，你可以开发自己的配置文件读取组件，用以替换当前的配置读取组件。

### 配置项和配置块
配置文件中的一个键如果目标是解析为某一个具体的变量的值，我们把这个键对应的配置叫做配置项。配置文件中的一个键如果目标是解析为一组变量的值，我们把这个键对应的配置叫做配置块。

配置块是由若干配置项或配置块组合而成，配置块也可以有子配置块。

配置项和配置块的概念是解析过程的概念，与解析文件本身是无关的。你的想要让一个键解析为配置项，它就是配置项，想要让它解析为配置块，它就是配置块。

### 组件
在 Goper 中，组件是一个实现了约定的方法的一个结构体类型（或者其他类型）。

Goper 中一切皆组件，整个 Goper 是由一个一个组件组合而成的，Goper 的核心代码本身也是几个组件。组件是构建 Goper 整体的单元，是 Goper 框架模块化实现的一种方式。

模块（module）作为 go 的一个概念，它更多指代的是同一个包下的代码实现，一个包实现一个模块。而 Goper 中的不同的组件并不一定在不同的模块中，同一个包下可以实现多个组件。不过作者在开发过程中，基本上一个组件独立为一个模块，所以事实上，作者偶尔会把组件和模块这两个概念窜用，因为本身组件化和模块化本身就是很接近的概念。

### 配置指令
确定了一个配置的键（字段值）、要解析的目标变量、发现这个字段时的回调、解析完这个字段时的回调的组合，由于它确定了一个配置解析过程的一些行为，我们把这个组合叫做配置指令。

一个组件会注册若干的配置指令来从配置文件中获取组件需要的配置参数。

要解析的目标变量如果是一个具体的变量，那么这个配置指令解析的就是一个配置项；通常如果要解析的目标变量为空指针，那么就这个配置指令解析的就是一个配置块。一个组件注册的配置块中的配置也是由这个组件所有。

### 关键字
一个组件会注册若干配置指令，如果一个配置指令解析的是配置块，那么这个配置块中的所有配置参数都会由对应的组件来获取。但是如果某个键被注册为关键字，那么后面在所有的配置块中出现这个键对应配置都将由注册这个关键字的组件所关注，执行这个组件注册的配置指令。


到了这里，如果你对这些概念还不是很理解，没关系，后面还会涉及到这些概念，到时再回过头来再看一次，就清楚了。

---
## 基本定义

### Cycle核心结构体
Cycle 包含了 Goper 整个运行周期都需要的参数，它在不同组件的各个方法中传递，实现不同组件之间的参数传递。具体定义如下：
```
type Cycle struct {
	Prefix     string        
	ConfFile   string        
	BinFile    string        
	Compts     []Componenter
	KindIndexs map[Kind][]int
}
```

它包含以下成员：
   - Prefix：是 Goper 的安装路径，这是在发布版本才会用到的参数，开发模式下即为可执行文件。
   - ConfFile：配置文件的全路径（包含文件名）。
   - BinFile：可执行文件的全路径（包含文件名）。
   - Compts：Goper 所有组件列表。
   - KindIndexs：不同种类组件的在 Compts 的索引，它是一个 map ，键为 Kind 类型，值为 []int 表示对应种类的组件在 Compts 中的下标。

由于它包含的东西都是整个 Goper 运行过程中需要的内容，我们就叫它核心结构体吧。

### 配置指令
即上一节提到的配置指令的定义实现。

在配置文件中，配置参数都是以键值对的形式存在，goper的config组件从配置文件中读取配置，读取到某个键后，会调用组件列表中组件的相关接口来确定具体是哪个组件关注这个键，进而将这个键对应的值解析到这个组件的具体配置中。

一个Command确定了一个组件的一个配置指令，它的定义如下：
```
type Command struct {
	Config              ConfigPair
	KeyWord             bool                          
	ConfigFoundCallback func(ConfigPair, *Cycle) error
	ConfigDoneCallback  func(ConfigPair, *Cycle) error
}
```  

它的具体成员如下：
   - 首先，它包含了Config成员，该成员是一个ConfigPair类型，ConfigPair类型定义了一个键值对，如下：

      ```
      type ConfigPair struct {
         Key   string     
         Value ConfigValue 
      }
      ```

      ConfigValue是一个参数值类型的定义，是any的重命名。

   - KeyWord表示该键是否注册为一个关键字，后面会具体介绍到关键字。
   - ConfigFoundCallback是找到该配置项的键时的回调。它接收两个参数，ConfigPair为该配置项中的Config成员，以及一个Cycle指针，返回值为error。
   - ConfigDoneCallback是解析完该配置项时的回调。它的参数同ConfigFoundCallback。

可以看到，一个Command确定了一个配置的键、值，以及找到该配置的回调、解析完该配置的回调，我们把这一组合叫做配置指令。

基础组件的CreateConfig返回了一组配置指令的数组，表示该组件关注的键。

特别注意，一个组件可能关注配置文件中的多个键，因此CreateConfig返回的是一个数组，而非单独一个Command。

---